import yfinance as yf
import pandas as pd
from typing import Optional, List

def get_stock_screener_yfinance(
    market_cap_higher: Optional[int] = None,
    market_cap_lower: Optional[int] = None,
    price_higher: Optional[int] = None,
    price_lower: Optional[int] = None,
    beta_higher: Optional[float] = None,
    beta_lower: Optional[float] = None,
    dividend_higher: Optional[float] = None,
    dividend_lower: Optional[float] = None,
) -> List[dict]:
    # 1. Danh sách mã cổ phiếu để kiểm tra
    tickers_to_check = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'JPM', 'V', 'PG', 'KO']
    filtered_stocks = []
    print(f"Bắt đầu sàng lọc {len(tickers_to_check)} mã cổ phiếu...")

    for ticker_symbol in tickers_to_check:
        try:
            ticker = yf.Ticker(ticker_symbol)
            info = ticker.info
            market_cap = info.get('marketCap')
            current_price = info.get('currentPrice')
            beta = info.get('beta')
            dividend_yield = (info.get('dividendRate', 0) / current_price * 100) if current_price and info.get('dividendRate') else 0
            passes_filter = True
            if passes_filter and market_cap is not None:
                if market_cap_higher is not None and market_cap > market_cap_higher:
                    passes_filter = False
                if market_cap_lower is not None and market_cap < market_cap_lower:
                    passes_filter = False
            if passes_filter and current_price is not None:
                if price_higher is not None and current_price > price_higher:
                    passes_filter = False
                if price_lower is not None and current_price < price_lower:
                    passes_filter = False
            if passes_filter and beta is not None:
                if beta_higher is not None and beta > beta_higher:
                    passes_filter = False
                if beta_lower is not None and beta < beta_lower:
                    passes_filter = False
            if passes_filter:
                if dividend_higher is not None and dividend_yield < dividend_higher:
                    passes_filter = False
                if dividend_lower is not None and dividend_yield > dividend_lower:
                    passes_filter = False
            if passes_filter:
                filtered_stocks.append({
                    'symbol': ticker_symbol,
                    'market_cap': market_cap,
                    'price': current_price,
                    'beta': beta,
                    'dividend_yield_percent': round(dividend_yield, 2)
                })

        except Exception as e:
            print(f"Lỗi khi xử lý mã {ticker_symbol}: {e}")
            continue

    return filtered_stocks
if __name__ == '__main__':
    # Tiêu chí sàng lọc
    filters = {
        'market_cap_lower': 500_000_000,
        'price_lower': 150,
        'price_higher': 8000,
        'beta_higher': 1.1,
        'dividend_lower': 0.5,
    }
    for key, value in filters.items():
        print(f"* {key}: {value:,}")
    results = get_stock_screener_yfinance(**filters)
    print("\n--- KẾT QUẢ ---")

    if results:
        df_results = pd.DataFrame(results)
        df_results.rename(columns={
            'symbol': 'Mã CK',
            'market_cap': 'Vốn hóa TT',
            'price': 'Giá hiện tại (USD)',
            'beta': 'Beta',
            'dividend_yield_percent': 'Tỷ suất Cổ tức (%)'
        }, inplace=True)
        df_results['Vốn hóa TT'] = (df_results['Vốn hóa TT'] / 1_000_000_000).round(2).astype(str) + ' Tỷ USD'
        df_results = df_results.sort_values(by='Vốn hóa TT', ascending=False)
        print(df_results.to_string(index=False))

        print("\n---------------------------------------------------------")
        print(f"Tổng số cổ phiếu vượt qua sàng lọc: {len(results)}")
    else:
        print("Không tìm thấy cổ phiếu nào phù hợp với các tiêu chí sàng lọc đã đặt.")


# * market_cap_lower: 500,000,000
# * price_lower: 150
# * price_higher: 8,000
# * beta_higher: 1.1
# * dividend_lower: 0.5
# Bắt đầu sàng lọc 9 mã cổ phiếu...

# --- KẾT QUẢ ---
# Mã CK     Vốn hóa TT  Giá hiện tại (USD)  Beta  Tỷ suất Cổ tức (%)
# GOOGL 3799.81 Tỷ USD              313.72  1.07                0.27

# ---------------------------------------------------------
# Tổng số cổ phiếu vượt qua sàng lọc: 1